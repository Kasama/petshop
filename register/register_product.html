<dom-module id="register-product-page">
		<script src="../important_js.js"></script>
  	<template>
	    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
	    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/js/materialize.min.js"></script>
	    <link href="../mystyle.css" rel="stylesheet">

		<!-- Main -->
		<main class="container">
			<section class="row">
				<div class="col s12">
					<article class="card">
						<div class="card-content">
							<header class="card-title">Registrar Produto</header>
							<div class="container" id="productForm">
								<div class="row">

									<div class="row">
										<div class="input-field col s12">
											<input placeholder="Nome do Produto" type="text" name="name" value="" id="name" />
										</div>
									</div>

									<div class="row">
										<div class="input-field col s4">
											<input placeholder="Preço" type="number" min="0.01" step="any" name="price" value="" id="price" />
										</div>

										<div class="input-field col s4">
											<input placeholder="Quantidade" type="number" min="0" step="any" name="stock" value="" id="stock" />
										</div>
									</div>

									<div class="row">
										<div class="input-field col s12">
											<textarea placeholder="Descrição" name="description" class="s12" rows="6" value="" id="description"></textarea>
										</div>
									</div>

									<div class="row">
										<div>
											<div class="file-field input-field col s9">
												<div class="btn">
													<span>Foto</span>
													<input id="image_button" type="file" name="image" accept="image/x-png,image/jpeg, image/jpg">
												</div>
												<div class="file-path-wrapper">
													<input id="image_path" class="file-path validate" placeholder="Arquivo" type="text" style="color:black">
												</div>
											</div>
										</div>
									</div>

									<div class="input-field s6 right">
											<button class="btn submit" type="submit" id="submit">Cadastrar →</button>
									</div>
								</div>
							</div>
						</div>
					</article>
				</div>
			</section>
		</main>
	</template>

	<script>
		Polymer({
				is: 'register-product-page',
				ready: function() {
						const imb = $(this.$.image_button);
						const imp = $(this.$.image_path);

						const name = $(this.$.name);
						const description = $(this.$.description);
						const price = $(this.$.price);
						const stock = $(this.$.stock);
						const image = $(this.$.image_button);

						imb.change(function(){
								imp[0].value = imb[0].value.substring(imb[0].value.lastIndexOf("\\") + 1)
						});

						/*
						$(this.$.productForm).submit(createModel(
								'product',
								$(this.$.image_button)
						));
						*/

						$(this.$.submit).click(e => {
								$.ajax('http://localhost:3000/products/add', {
										cache: false,
										data: {
												name: name.val(),
												description: description.val(),
												stock: stock.val(),
												price: price.val(),
										},
										success: (result, status, xhr) => {
												const res = result;
												const id = result.data._id;
												const file = image[0].files[0];
												const data = new FormData();
												data.append('image', file, file.name);
												$.ajax('http://localhost:3000/products/' + id + '/picture', {
														cache: false,
														method: 'POST',
														processData: false,
														contentType: false,
														data: data,
														success: (result, status, xhr) => {
																alert("Got success " + JSON.stringify(result) + " and " + JSON.stringify(res));
														},
														error: (xhr, status, error) => {
																alert("Got error " + JSON.stringify(error));
														},
												});
										},
										error: (xhr, status, error) => {
												alert("Got error " + JSON.stringify(error));
										},
										method: 'POST',
								});
						});
				}
		});
	</script>
</dom-module>
